generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model accommodations {
  id            String   @id
  name          String
  type          String
  description   String?
  address       String
  city          String
  country       String
  pricePerMonth Decimal?
  currency      String?
  imageUrl      String?
  amenities     Json?
  contactInfo   Json?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

model admin_destinations {
  id                   String    @id
  name                 String
  city                 String
  country              String
  description          String
  imageUrl             String?
  climate              String?
  highlights           Json?
  officialUniversities Json?
  generalInfo          Json?
  studentDataCache     Json?
  hasStudentData       Boolean   @default(false)
  lastDataUpdate       DateTime?
  featured             Boolean   @default(false)
  active               Boolean   @default(true)
  createdBy            String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime

  @@unique([city, country])
}

model agreements {
  id                                                        String         @id
  homeUniversityId                                          String
  homeDepartmentId                                          String
  partnerUniversityId                                       String
  partnerCity                                               String
  partnerCountry                                            String
  agreementType                                             String         @default("BOTH")
  notes                                                     String?
  isActive                                                  Boolean        @default(true)
  startDate                                                 DateTime?
  endDate                                                   DateTime?
  createdAt                                                 DateTime       @default(now())
  updatedAt                                                 DateTime
  departments                                               departments    @relation(fields: [homeDepartmentId], references: [id])
  universities_agreements_homeUniversityIdTouniversities    universities   @relation("agreements_homeUniversityIdTouniversities", fields: [homeUniversityId], references: [id])
  universities_agreements_partnerUniversityIdTouniversities universities   @relation("agreements_partnerUniversityIdTouniversities", fields: [partnerUniversityId], references: [id])
  applications                                              applications[]
}

model applications {
  id               String       @id
  userId           String
  homeUniversityId String
  programId        String
  agreementId      String
  status           String       @default("DRAFT")
  semester         String?
  academicYear     String?
  duration         String?
  motivation       String?
  languageSkills   Json?
  grades           Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  agreements       agreements   @relation(fields: [agreementId], references: [id])
  universities     universities @relation(fields: [homeUniversityId], references: [id])
  programs         programs     @relation(fields: [programId], references: [id])
  users            users        @relation(fields: [userId], references: [id])
}

model custom_destinations {
  id            String   @id
  destinationId String   @unique
  data          Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

model departments {
  id          String       @id
  name        String
  description String?
  facultyId   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  agreements  agreements[]
  faculties   faculties    @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  programs    programs[]
}

model destination_submissions {
  id               String           @id
  destinationId    String
  submissionId     String
  contributionType String
  weight           Float            @default(1.0)
  adminApproved    Boolean          @default(false)
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  destinations     destinations     @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  form_submissions form_submissions @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([destinationId, submissionId])
}

model destinations {
  id                      String                    @id
  name                    String
  city                    String
  country                 String
  description             String?
  imageUrl                String?
  featured                Boolean                   @default(false)
  status                  String                    @default("published")
  source                  String                    @default("admin_created")
  climate                 String?
  costOfLiving            Json?
  highlights              String?
  photos                  Json?
  generalInfo             Json?
  aggregatedData          Json?
  adminOverrides          Json?
  submissionCount         Int                       @default(0)
  lastDataUpdate          DateTime                  @default(now())
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  destination_submissions destination_submissions[]

  @@unique([city, country])
}

model erasmus_experiences {
  id             String  @id
  userId         String  @unique
  currentStep    Int     @default(1)
  completedSteps String  @default("[]")
  isComplete     Boolean @default(false)

  // Core data (JSON for flexibility)
  basicInfo      Json?
  courses        Json?
  accommodation  Json?
  livingExpenses Json?
  experience     Json?

  // Submission workflow
  status      String    @default("DRAFT") // DRAFT | SUBMITTED | APPROVED | REJECTED | REVISION_NEEDED
  isPublic    Boolean   @default(false)
  lastSavedAt DateTime  @default(now())
  submittedAt DateTime?
  publishedAt DateTime?

  // NEW: Submission context
  semester         String? // "2024-FALL" | "2024-SPRING" | "2024-SUMMER" | "2024-FULL"
  hostCity         String?
  hostCountry      String?
  hostUniversityId String?
  homeUniversityId String?

  // NEW: Admin review
  adminNotes     String?
  adminApproved  Boolean   @default(false)
  reviewedAt     DateTime?
  reviewedBy     String?
  reviewFeedback String?
  revisionCount  Int       @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime

  // Relations
  users          users          @relation(fields: [userId], references: [id], onDelete: Cascade)
  hostUniversity universities?  @relation("hostExperiences", fields: [hostUniversityId], references: [id])
  homeUniversity universities?  @relation("homeExperiences", fields: [homeUniversityId], references: [id])
  reviewActions  ReviewAction[]

  @@unique([userId, semester])
  @@index([status, hostCity, hostCountry])
  @@index([semester])
  @@index([hostUniversityId, homeUniversityId])
}

// NEW: Admin review audit log
model ReviewAction {
  id           String              @id @default(cuid())
  experienceId String
  experience   erasmus_experiences @relation(fields: [experienceId], references: [id], onDelete: Cascade)
  adminId      String
  admin        users               @relation("ReviewActions", fields: [adminId], references: [id])
  action       String // "APPROVED" | "REJECTED" | "REVISION_REQUESTED"
  feedback     String?
  createdAt    DateTime            @default(now())

  @@index([experienceId])
  @@index([adminId])
  @@map("review_actions")
}

// NEW: Pre-calculated city statistics
model CityStatistics {
  id       String @id @default(cuid())
  city     String
  country  String
  semester String // "2024-FALL" or "ALL" for all-time

  // Accommodation stats (EUR cents)
  avgMonthlyRentCents Int?
  medianRentCents     Int?
  minRentCents        Int?
  maxRentCents        Int?
  rentSampleSize      Int  @default(0)

  // Living expenses stats (EUR cents)
  avgGroceriesCents     Int?
  avgTransportCents     Int?
  avgEatingOutCents     Int?
  avgSocialLifeCents    Int?
  avgTotalExpensesCents Int?
  expenseSampleSize     Int  @default(0)

  // Metadata
  lastCalculated DateTime @default(now())
  createdAt      DateTime @default(now())

  @@unique([city, country, semester])
  @@index([city, country])
  @@index([semester])
  @@map("city_statistics")
}

model faculties {
  id           String        @id
  name         String
  description  String?
  universityId String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime
  departments  departments[]
  universities universities  @relation(fields: [universityId], references: [id], onDelete: Cascade)
}

model form_submissions {
  id                      String                    @id
  userId                  String
  type                    String
  title                   String
  data                    Json
  status                  String                    @default("SUBMITTED")
  adminNotes              String?
  processed               Boolean                   @default(false)
  qualityScore            Float?
  tags                    String?
  location                String?
  submissionSource        String                    @default("form")
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  hostCity                String?
  hostCountry             String?
  destination_submissions destination_submissions[]
  users                   users                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([hostCity, hostCountry])
  @@index([location, status])
  @@index([type, status])
}

model generated_accommodations {
  id                     String                 @id
  destinationId          String
  sourceExperienceId     String
  studentName            String?
  accommodationType      String
  neighborhood           String?
  monthlyRent            Float?
  currency               String                 @default("EUR")
  title                  String
  description            String
  pros                   Json?
  cons                   Json?
  tips                   Json?
  bookingAdvice          String?
  featured               Boolean                @default(false)
  visible                Boolean                @default(true)
  adminNotes             String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  generated_destinations generated_destinations @relation(fields: [destinationId], references: [id], onDelete: Cascade)
}

model generated_course_exchanges {
  id                     String                 @id
  destinationId          String
  sourceExperienceId     String
  studentName            String?
  hostUniversity         String
  fieldOfStudy           String?
  studyLevel             String?
  semester               String?
  title                  String
  description            String
  courseQuality          Int?
  professorQuality       Int?
  facilityQuality        Int?
  coursesEnrolled        Json?
  creditsEarned          Int?
  language               String?
  academicChallenges     String?
  academicHighlights     String?
  tips                   Json?
  featured               Boolean                @default(false)
  visible                Boolean                @default(true)
  adminNotes             String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime
  generated_destinations generated_destinations @relation(fields: [destinationId], references: [id], onDelete: Cascade)
}

model generated_destinations {
  id                         String                       @id
  slug                       String                       @unique
  city                       String
  country                    String
  totalSubmissions           Int                          @default(0)
  averageRating              Float?
  averageMonthlyCost         Float?
  averageAccommodationCost   Float?
  topNeighborhoods           Json?
  commonPros                 Json?
  commonCons                 Json?
  budgetBreakdown            Json?
  adminTitle                 String?
  adminDescription           String?
  adminImageUrl              String?
  adminHighlights            Json?
  adminGeneralInfo           Json?
  status                     String                       @default("DRAFT")
  featured                   Boolean                      @default(false)
  lastCalculated             DateTime                     @default(now())
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime
  generated_accommodations   generated_accommodations[]
  generated_course_exchanges generated_course_exchanges[]

  @@unique([city, country])
}

model partnership_tracking {
  id                    String    @id
  homeUniversityName    String
  partnerUniversityName String
  partnerCity           String
  partnerCountry        String
  agreementType         String?
  fieldOfStudy          String?
  isActive              Boolean   @default(true)
  totalSubmissions      Int       @default(0)
  averageRating         Float?
  averageAcademicRating Float?
  lastSubmissionDate    DateTime?
  submissionsByYear     Json?
  ratingTrend           Json?
  adminNotes            String?
  needsAttention        Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime

  @@unique([homeUniversityName, partnerUniversityName, partnerCity])
  @@index([partnerCountry, partnerCity])
  @@index([needsAttention, isActive])
}

model programs {
  id           String         @id
  name         String
  level        String
  duration     String
  type         String?
  ects         Int?
  description  String?
  departmentId String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  applications applications[]
  departments  departments    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
}

model stories {
  id                String              @id
  title             String
  content           String
  excerpt           String?
  imageUrl          String?
  isPublic          Boolean             @default(true)
  isPinned          Boolean             @default(false)
  authorId          String
  universityId      String?
  country           String?
  city              String?
  category          String              @default("EXPERIENCE")
  tags              String?
  likes             Int                 @default(0)
  views             Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  users             users               @relation(fields: [authorId], references: [id])
  universities      universities?       @relation(fields: [universityId], references: [id])
  story_engagements story_engagements[]

  @@index([city, country])
  @@index([isPublic, isPinned])
  @@index([createdAt, isPublic])
}

model story_engagements {
  id         String    @id
  storyId    String
  userId     String
  liked      Boolean   @default(false)
  bookmarked Boolean   @default(false)
  rating     Int       @default(0)
  views      Int       @default(0)
  likes      Int       @default(0)
  comments   Int       @default(0)
  lastViewed DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  stories    stories   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  users      users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
}

model universities {
  id                                                      String         @id
  code                                                    String         @unique
  name                                                    String
  shortName                                               String
  type                                                    String
  country                                                 String
  city                                                    String
  website                                                 String?
  description                                             String?
  imageUrl                                                String?
  createdAt                                               DateTime       @default(now())
  updatedAt                                               DateTime
  agreements_agreements_homeUniversityIdTouniversities    agreements[]   @relation("agreements_homeUniversityIdTouniversities")
  agreements_agreements_partnerUniversityIdTouniversities agreements[]   @relation("agreements_partnerUniversityIdTouniversities")
  applications                                            applications[]
  faculties                                               faculties[]
  stories                                                 stories[]

  // NEW: Erasmus experience relations
  hostExperiences erasmus_experiences[] @relation("hostExperiences")
  homeExperiences erasmus_experiences[] @relation("homeExperiences")
}

model university_exchanges {
  id                  String   @id
  hostUniversity      String
  hostCountry         String
  hostCity            String
  studyLevel          String
  fieldOfStudy        String
  description         String?
  imageUrl            String?
  highlights          String?
  requirements        String?
  applicationDeadline String?
  totalEcts           Int?
  language            String   @default("English")
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime
}

model users {
  id                  String               @id
  firstName           String?
  lastName            String?
  email               String               @unique
  emailVerified       DateTime?
  image               String?
  password            String?
  role                String               @default("USER")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  studentId           String?
  nationality         String?
  homeCity            String?
  homeCountry         String?
  Account             Account[]
  Session             Session[]
  applications        applications[]
  erasmus_experiences erasmus_experiences?
  form_submissions    form_submissions[]
  stories             stories[]
  story_engagements   story_engagements[]

  // NEW: Admin review actions
  reviewActions ReviewAction[] @relation("ReviewActions")
}
